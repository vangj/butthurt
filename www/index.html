<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Butt Hurt Report</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
      href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap"
      rel="stylesheet"
    >
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    >
    <style>
      body {
        background-color: #f3f4f6;
        font-family: "Helvetica Neue", Arial, sans-serif;
      }

      .sheet {
        background-color: #ffffff;
        border: 2px solid #000;
        margin: 0 auto;
        max-width: 960px;
        padding: 2.5rem 2rem;
      }

      .form-title {
        letter-spacing: 0.08em;
      }

      .info-box {
        border: 1.5px solid #000;
        padding: 1rem 1.25rem;
      }

      .info-label {
        font-size: 0.8rem;
        font-weight: 700;
        letter-spacing: 0.05em;
        text-transform: uppercase;
      }

      .section-title {
        font-size: 1rem;
        font-weight: 700;
        letter-spacing: 0.08em;
        margin-bottom: 1.25rem;
        text-align: center;
        text-transform: uppercase;
      }

      .section-title small {
        display: block;
        font-size: 0.85rem;
        font-weight: 600;
        letter-spacing: 0.04em;
        text-transform: none;
      }

      .form-section {
        border: 1.5px solid #000;
        margin-bottom: 1.5rem;
        padding: 1.5rem;
      }

      .form-label,
      legend {
        font-size: 0.82rem;
        font-weight: 700;
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }

      .form-label {
        margin-bottom: 0.25rem;
      }

      legend {
        float: none;
        margin-bottom: 0.75rem;
        width: auto;
      }

      .question-legend {
        font-size: 0.94rem;
        font-weight: 600;
        letter-spacing: 0.02em;
        text-transform: none;
      }

      .form-control,
      textarea {
        border: 1.5px solid #000;
        border-radius: 0;
        min-height: 3rem;
      }

      textarea {
        min-height: 10rem;
      }

      .form-check-input {
        border: 1.5px solid #000;
        border-radius: 0;
        height: 1.25rem;
        margin-top: 0;
        width: 1.25rem;
      }

      .form-check-input:checked {
        background-color: #000;
        border-color: #000;
      }

      .form-check-label {
        font-size: 0.9rem;
        font-weight: 600;
      }

      #part-vi-b {
        font-family: "Great Vibes", "Brush Script MT", cursive;
        font-size: 2rem;
        letter-spacing: 0.05em;
      }

      .reason-grid .col {
        display: flex;
      }

      .reason-grid .form-check {
        align-items: center;
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0;
        padding: 0.25rem 0 0.25rem 0.75rem;
      }

      @media (max-width: 576px) {
        .sheet {
          padding: 1.75rem 1.25rem;
        }
      }
    </style>
  </head>
  <body>
    <main class="container-fluid py-4">
      <article class="sheet" role="document">
        <header class="text-center mb-4">
          <h1 class="form-title text-uppercase display-6 fw-bold mb-3">Butt Hurt Report</h1>
          <p class="text-uppercase fw-semibold mb-3">Data Required By The Privacy Act Of 1974</p>
          <div class="info-box">
            <div class="row g-4">
              <div class="col-md-6">
                <p class="info-label mb-1">Principal Purpose:</p>
                <p class="mb-0">To assist whiners in documenting hurt feelings.</p>
              </div>
              <div class="col-md-6">
                <p class="info-label mb-1">Routine Uses:</p>
                <p class="mb-0">Leaders &amp; whiners should use this form as necessary.</p>
              </div>
            </div>
          </div>
        </header>

        <form novalidate>
          <section class="form-section" aria-labelledby="part-administrative">
            <h2 class="section-title" id="part-administrative">Part I - Administrative Data</h2>
            <div class="row g-3">
              <div class="col-md-5">
                <label for="part-i-a" class="form-label">A. Whiner's Name (Last, First, MI)</label>
                <input type="text" class="form-control" id="part-i-a" name="part_i_a" autocomplete="name" required>
              </div>
              <div class="col-md-4">
                <label for="part-i-b" class="form-label">B. Social Security Number</label>
                <input type="text" class="form-control" id="part-i-b" name="part_i_b" inputmode="numeric" maxlength="11" pattern="[0-9]{3}-[0-9]{2}-[0-9]{4}" placeholder="555-55-1111" title="Enter Social Security Number as 555-55-1111.">
              </div>
              <div class="col-md-3">
                <label for="part-i-c" class="form-label">C. Date Of Report</label>
                <input type="date" class="form-control" id="part-i-c" name="part_i_c">
              </div>
            </div>
            <div class="row g-3">
              <div class="col-md-6">
                <label for="part-i-d" class="form-label">D. Organization</label>
                <input type="text" class="form-control" id="part-i-d" name="part_i_d">
              </div>
              <div class="col-md-6">
                <label for="part-i-e" class="form-label">E. Name &amp; Title Of Person Filling Out This Form</label>
                <input type="text" class="form-control" id="part-i-e" name="part_i_e">
              </div>
            </div>
          </section>

          <section class="form-section" aria-labelledby="part-incident">
            <h2 class="section-title" id="part-incident">Part II - Incident Report</h2>
            <div class="row g-3">
              <div class="col-md-4">
                <label for="part-ii-a" class="form-label">A. Date Feelings Were Hurt</label>
                <input type="date" class="form-control" id="part-ii-a" name="part_ii_a">
              </div>
              <div class="col-md-4">
                <label for="part-ii-b" class="form-label">B. Time Of Hurtfulness</label>
                <input type="time" class="form-control" id="part-ii-b" name="part_ii_b">
              </div>
              <div class="col-md-4">
                <label for="part-ii-c" class="form-label">C. Location Of Hurtful Incident</label>
                <input type="text" class="form-control" id="part-ii-c" name="part_ii_c" autocomplete="off">
              </div>
            </div>
            <div class="row g-3">
              <div class="col-md-6">
                <label for="part-ii-d" class="form-label">D. Name Of Real Man/Woman Who Hurt Your Sensitive Feelings</label>
                <input type="text" class="form-control" id="part-ii-d" name="part_ii_d" autocomplete="name" required>
              </div>
              <div class="col-md-6">
                <label for="part-ii-e" class="form-label">E. Organization</label>
                <input type="text" class="form-control" id="part-ii-e" name="part_ii_e">
              </div>
            </div>
          </section>

          <section class="form-section" aria-labelledby="part-injury">
            <h2 class="section-title" id="part-injury">Part III - Injury</h2>

            <fieldset class="mb-4">
              <legend class="question-legend">1. Which ear were the words of hurtfulness spoken into?</legend>
              <div class="row g-3">
                <div class="col-sm-4">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="part_iii_1" id="part-iii-1-left" value="left">
                    <label class="form-check-label" for="part-iii-1-left">Left</label>
                  </div>
                </div>
                <div class="col-sm-4">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="part_iii_1" id="part-iii-1-right" value="right">
                    <label class="form-check-label" for="part-iii-1-right">Right</label>
                  </div>
                </div>
                <div class="col-sm-4">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="part_iii_1" id="part-iii-1-both" value="both">
                    <label class="form-check-label" for="part-iii-1-both">Both</label>
                  </div>
                </div>
              </div>
            </fieldset>

            <fieldset class="mb-4">
              <legend class="question-legend">2. Is there permanent feeling damage?</legend>
              <div class="row g-3">
                <div class="col-sm-4">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="part_iii_2" id="part-iii-2-yes" value="yes">
                    <label class="form-check-label" for="part-iii-2-yes">Yes</label>
                  </div>
                </div>
                <div class="col-sm-4">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="part_iii_2" id="part-iii-2-no" value="no">
                    <label class="form-check-label" for="part-iii-2-no">No</label>
                  </div>
                </div>
                <div class="col-sm-4">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="part_iii_2" id="part-iii-2-maybe" value="maybe">
                    <label class="form-check-label" for="part-iii-2-maybe">Maybe</label>
                  </div>
                </div>
              </div>
            </fieldset>

            <fieldset class="mb-4">
              <legend class="question-legend">3. Did you require a &ldquo;tissue&rdquo; for tears?</legend>
              <div class="row g-3">
                <div class="col-sm-4">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="part_iii_3" id="part-iii-3-yes" value="yes">
                    <label class="form-check-label" for="part-iii-3-yes">Yes</label>
                  </div>
                </div>
                <div class="col-sm-4">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="part_iii_3" id="part-iii-3-no" value="no">
                    <label class="form-check-label" for="part-iii-3-no">No</label>
                  </div>
                </div>
                <div class="col-sm-4">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="part_iii_3" id="part-iii-3-multiple" value="multiple">
                    <label class="form-check-label" for="part-iii-3-multiple">Multiple</label>
                  </div>
                </div>
              </div>
            </fieldset>

            <fieldset class="mb-0">
              <legend class="question-legend">4. Has this resulted in a traumatic brain injury?</legend>
              <div class="row g-3">
                <div class="col-sm-4">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="part_iii_4" id="part-iii-4-yes" value="yes">
                    <label class="form-check-label" for="part-iii-4-yes">Yes</label>
                  </div>
                </div>
                <div class="col-sm-4">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="part_iii_4" id="part-iii-4-no" value="no">
                    <label class="form-check-label" for="part-iii-4-no">No</label>
                  </div>
                </div>
                <div class="col-sm-4">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="part_iii_4" id="part-iii-4-maybe" value="maybe">
                    <label class="form-check-label" for="part-iii-4-maybe">Maybe</label>
                  </div>
                </div>
              </div>
            </fieldset>
          </section>

          <section class="form-section" aria-labelledby="part-reason">
            <h2 class="section-title" id="part-reason">Part IV - Reason For Filing This Report (Mark all that apply)</h2>
            <fieldset>
              <legend class="visually-hidden">Select all applicable reasons</legend>
              <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-3 reason-grid">
                <div class="col">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="part-iv-1" name="part_iv_1" value="thin_skinned">
                    <label class="form-check-label" for="part-iv-1">I am thin skinned</label>
                  </div>
                </div>
                <div class="col">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="part-iv-2" name="part_iv_2" value="wimp">
                    <label class="form-check-label" for="part-iv-2">I am a wimp</label>
                  </div>
                </div>
                <div class="col">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="part-iv-3" name="part_iv_3" value="hormones">
                    <label class="form-check-label" for="part-iv-3">I have woman/man-like hormones</label>
                  </div>
                </div>
                <div class="col">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="part-iv-4" name="part_iv_4" value="crybaby">
                    <label class="form-check-label" for="part-iv-4">I am a crybaby</label>
                  </div>
                </div>
                <div class="col">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="part-iv-5" name="part_iv_5" value="mommy">
                    <label class="form-check-label" for="part-iv-5">I want my mommy</label>
                  </div>
                </div>
                <div class="col">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="part-iv-6" name="part_iv_6" value="fix_problems">
                    <label class="form-check-label" for="part-iv-6">Someone needs to fix my problems</label>
                  </div>
                </div>
                <div class="col">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="part-iv-7" name="part_iv_7" value="easily_hurt">
                    <label class="form-check-label" for="part-iv-7">My feelings are easily hurt</label>
                  </div>
                </div>
                <div class="col">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="part-iv-8" name="part_iv_8" value="did_not_sign_up">
                    <label class="form-check-label" for="part-iv-8">I didn't sign up for this</label>
                  </div>
                </div>
                <div class="col">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="part-iv-9" name="part_iv_9" value="not_hero">
                    <label class="form-check-label" for="part-iv-9">I was told that I am not a hero</label>
                  </div>
                </div>
                <div class="col">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="part-iv-10" name="part_iv_10" value="weather">
                    <label class="form-check-label" for="part-iv-10">The weather is too cold/hot</label>
                  </div>
                </div>
                <div class="col">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="part-iv-11" name="part_iv_11" value="beers">
                    <label class="form-check-label" for="part-iv-11">Two beers is not enough</label>
                  </div>
                </div>
                <div class="col">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="part-iv-12" name="part_iv_12" value="hands_should_be_in_pockets">
                    <label class="form-check-label" for="part-iv-12">My hands should be in pockets</label>
                  </div>
                </div>
                <div class="col">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="part-iv-13" name="part_iv_13" value="no_post_brief">
                    <label class="form-check-label" for="part-iv-13">I was not offered a post brief</label>
                  </div>
                </div>
                <div class="col">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="part-iv-14" name="part_iv_14" value="requested_post_brief">
                    <label class="form-check-label" for="part-iv-14">Someone requested a post brief</label>
                  </div>
                </div>
                <div class="col">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="part-iv-15" name="part_iv_15" value="all_of_the_above">
                    <label class="form-check-label" for="part-iv-15">All of the above and more</label>
                  </div>
                </div>
              </div>
            </fieldset>
          </section>

          <section class="form-section" aria-labelledby="part-narrative">
            <h2 class="section-title" id="part-narrative">
              <span>Part V - Narrative</span>
              <br>
              <small>(Tell us in your own sissy words how your feelings were hurt.)</small>
            </h2>
            <div>
              <label for="part-v" class="visually-hidden">Narrative Description</label>
              <textarea class="form-control" id="part-v" name="part_v"></textarea>
            </div>
          </section>

          <section class="form-section mb-0" aria-labelledby="part-authentication">
            <h2 class="section-title" id="part-authentication">Part VI - Authentication</h2>
            <div class="row g-3">
              <div class="col-md-6">
                <label for="part-vi-a" class="form-label">A. Printed Name Of Whiner</label>
                <input type="text" class="form-control" id="part-vi-a" name="part_vi_a" autocomplete="name" required>
              </div>
              <div class="col-md-6">
                <label for="part-vi-b" class="form-label">B. Signature</label>
                <input type="text" class="form-control" id="part-vi-b" name="part_vi_b" autocomplete="off" readonly>
              </div>
            </div>
          </section>
          <div class="d-flex justify-content-end mt-4 gap-3">
            <button type="button" id="generate-pdf-btn" class="btn btn-dark btn-lg text-uppercase fw-semibold">Generate PDF</button>
            <button type="button" id="generate-jpg-btn" class="btn btn-outline-dark btn-lg text-uppercase fw-semibold">Generate JPG</button>
          </div>
        </form>
      </article>
    </main>
    <script type="module">
      import { PDFDocument } from "https://cdn.skypack.dev/pdf-lib@1.17.1?min";

      const blankPdfUrl = new URL("blank_form.pdf", window.location.href);
      const rendererWorkerUrl = new URL("./pdf-renderer.worker.js", import.meta.url);

      const setTextFields = (form, mappings) => {
        for (const [fieldName, value] of Object.entries(mappings)) {
          const textField = form.getTextField(fieldName);
          textField.setText(value ?? "");
        }
      };

      const setCheckBoxes = (form, mappings) => {
        for (const [fieldName, checked] of Object.entries(mappings)) {
          const checkBox = form.getCheckBox(fieldName);
          if (checked) {
            checkBox.check();
          } else {
            checkBox.uncheck();
          }
        }
      };

      const collectRadioSelections = (radioConfig) => {
        const selections = {};
        for (const [fieldName, config] of Object.entries(radioConfig)) {
          const { htmlName, matchers } = config;
          const checkedInputs = Array.from(
            document.querySelectorAll(`input[name="${htmlName}"]:checked`)
          );
          const selectedValue = checkedInputs.length
            ? checkedInputs[0].value.toLowerCase()
            : null;
          const selectedConfig =
            selectedValue && matchers[selectedValue] ? matchers[selectedValue] : null;
          selections[fieldName] = selectedConfig?.onValue ?? null;
        }
        return selections;
      };

      const applyRadioSelections = (form, selections) => {
        for (const [fieldName, onValue] of Object.entries(selections)) {
          let radioGroup;
          try {
            radioGroup = form.getRadioGroup(fieldName);
          } catch (error) {
            console.warn(`Unable to access radio group ${fieldName}:`, error);
            continue;
          }

          if (onValue) {
            try {
              radioGroup.select(onValue);
            } catch (error) {
              console.warn(`Unable to select ${onValue} for ${fieldName}:`, error);
              try {
                radioGroup.clear();
              } catch (clearError) {
                console.warn(`Unable to clear radio group ${fieldName}:`, clearError);
              }
            }
          } else {
            try {
              radioGroup.clear();
            } catch (error) {
              console.warn(`Unable to clear radio group ${fieldName}:`, error);
            }
          }
        }
      };

      const radioGroupsConfig = {
        injury_question1: {
          htmlName: "part_iii_1",
          matchers: {
            left: { tooltip: "option is left", onValue: "LEFT" },
            right: { tooltip: "option is right", onValue: "RIGHT" },
            both: { tooltip: "option is both", onValue: "BOTH" }
          }
        },
        injury_question2: {
          htmlName: "part_iii_2",
          matchers: {
            yes: { tooltip: "option is yes", onValue: "YES" },
            no: { tooltip: "option is no", onValue: "NO" },
            maybe: { tooltip: "option is maybe", onValue: "MAYBE" }
          }
        },
        injury_question3: {
          htmlName: "part_iii_3",
          matchers: {
            yes: { tooltip: "option is yes", onValue: "YES" },
            no: { tooltip: "option is no", onValue: "NO" },
            multiple: { tooltip: "option is multiple", onValue: "MULTIPLE" }
          }
        },
        injury_question4: {
          htmlName: "part_iii_4",
          matchers: {
            yes: { tooltip: "option is yes", onValue: "YES" },
            no: { tooltip: "option is no", onValue: "NO" },
            maybe: { tooltip: "option is maybe", onValue: "MAYBE" }
          }
        }
      };

      const htmlForm = document.querySelector("form");
      const whinerNameInput = document.getElementById("part-i-a");
      const authWhinerNameInput = document.getElementById("part-vi-a");
      const signatureInput = document.getElementById("part-vi-b");
      const offenderInput = document.getElementById("part-ii-d");
      const ssnInput = document.getElementById("part-i-b");

      const signatureFontUrl = new URL("fonts/GreatVibes-Regular.ttf", window.location.href);
      let signatureFontBytesPromise = null;
      let fontkitModulePromise = null;

      const loadSignatureFontBytes = async () => {
        if (!signatureFontBytesPromise) {
          signatureFontBytesPromise = fetch(signatureFontUrl)
            .then((response) => {
              if (!response.ok) {
                throw new Error("Unable to load signature font.");
              }
              return response.arrayBuffer();
            })
            .catch((error) => {
              signatureFontBytesPromise = null;
              throw error;
            });
        }
        return signatureFontBytesPromise;
      };

      const loadFontkitModule = async () => {
        if (!fontkitModulePromise) {
          fontkitModulePromise = import("https://cdn.skypack.dev/@pdf-lib/fontkit@1.1.1")
            .then((module) => module.default || module)
            .catch((error) => {
              fontkitModulePromise = null;
              throw error;
            });
        }
        return fontkitModulePromise;
      };

      const syncFieldValue = (source, target) => {
        if (!source || !target) return;
        if (target.value !== source.value) {
          target.value = source.value;
        }
      };

      const normalizeSignatureText = (value) =>
        value.trim().replace(/\s+/g, " ");

      const updateSignatureFromName = (rawValue) => {
        if (!signatureInput) return;
        const trimmed = rawValue ? normalizeSignatureText(rawValue) : "";
        if (!trimmed) {
          signatureInput.value = "";
          return;
        }
        signatureInput.value = trimmed;
      };

      whinerNameInput?.addEventListener("input", () => {
        syncFieldValue(whinerNameInput, authWhinerNameInput);
        updateSignatureFromName(authWhinerNameInput?.value ?? "");
      });

      authWhinerNameInput?.addEventListener("input", () => {
        syncFieldValue(authWhinerNameInput, whinerNameInput);
        updateSignatureFromName(authWhinerNameInput.value);
      });

      if (whinerNameInput && authWhinerNameInput) {
        if (whinerNameInput.value && !authWhinerNameInput.value) {
          authWhinerNameInput.value = whinerNameInput.value;
        } else if (!whinerNameInput.value && authWhinerNameInput.value) {
          whinerNameInput.value = authWhinerNameInput.value;
        }
        updateSignatureFromName(authWhinerNameInput.value);
      }
      updateSignatureFromName(authWhinerNameInput?.value ?? "");

      const validateForm = () => {
        if (!htmlForm) return true;

        if (whinerNameInput) {
          const whinerValue = whinerNameInput.value.trim();
          whinerNameInput.setCustomValidity(
            whinerValue ? "" : "Please enter the whiner's name."
          );
        }

        if (authWhinerNameInput && whinerNameInput) {
          const whinerValue = whinerNameInput.value.trim();
          const authValue = authWhinerNameInput.value.trim();
          let authMessage = "";

          if (!authValue) {
            authMessage = "Please enter the whiner's name.";
          } else if (whinerValue && authValue !== whinerValue) {
            authMessage = "Printed name must match whiner's name.";
          }

          authWhinerNameInput.setCustomValidity(authMessage);
        }

        if (offenderInput) {
          const offenderValue = offenderInput.value.trim();
          offenderInput.setCustomValidity(
            offenderValue
              ? ""
              : "Please enter the name of the person who hurt your feelings."
          );
        }

        if (ssnInput) {
          const ssnValue = ssnInput.value.trim();
          if (!ssnValue) {
            ssnInput.setCustomValidity("");
          } else if (/^[0-9]{3}-[0-9]{2}-[0-9]{4}$/.test(ssnValue)) {
            ssnInput.setCustomValidity("");
          } else {
            ssnInput.setCustomValidity(
              "Enter Social Security Number in format 555-55-1111."
            );
          }
        }

        return htmlForm.reportValidity();
      };

      const pdfButton = document.getElementById("generate-pdf-btn");
      const jpgButton = document.getElementById("generate-jpg-btn");

      const setButtonsDisabled = (disabled) => {
        for (const btn of [pdfButton, jpgButton]) {
          if (btn) {
            btn.disabled = disabled;
          }
        }
      };

      const triggerDownload = (blob, filename) => {
        const downloadUrl = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = downloadUrl;
        link.download = filename;
        link.click();
        setTimeout(() => {
          URL.revokeObjectURL(downloadUrl);
        }, 0);
      };

      const getInputValue = (id) => document.getElementById(id)?.value ?? "";
      const isChecked = (id) => document.getElementById(id)?.checked ?? false;

      const collectFormValues = () => ({
        textFields: {
          admin_whiner_name: getInputValue("part-i-a"),
          admin_social_security: getInputValue("part-i-b"),
          admin_report_date: getInputValue("part-i-c"),
          admin_organization: getInputValue("part-i-d"),
          admin_preparer_name: getInputValue("part-i-e"),
          incident_date: getInputValue("part-ii-a"),
          incident_time: getInputValue("part-ii-b"),
          incident_location: getInputValue("part-ii-c"),
          incident_offender_name: getInputValue("part-ii-d"),
          incident_offender_org: getInputValue("part-ii-e"),
          narrative_text: getInputValue("part-v"),
          auth_whiner_name: getInputValue("part-vi-a")
        },
        signature: getInputValue("part-vi-b"),
        checkboxes: {
          reason_filing_1: isChecked("part-iv-1"),
          reason_filing_4: isChecked("part-iv-2"),
          reason_filing_7: isChecked("part-iv-3"),
          reason_filing_10: isChecked("part-iv-4"),
          reason_filing_13: isChecked("part-iv-5"),
          reason_filing_2: isChecked("part-iv-6"),
          reason_filing_5: isChecked("part-iv-7"),
          reason_filing_8: isChecked("part-iv-8"),
          reason_filing_11: isChecked("part-iv-9"),
          reason_filing_14: isChecked("part-iv-10"),
          reason_filing_3: isChecked("part-iv-11"),
          reason_filing_6: isChecked("part-iv-12"),
          reason_filing_9: isChecked("part-iv-13"),
          reason_filing_12: isChecked("part-iv-14"),
          reason_filing_15: isChecked("part-iv-15")
        },
        radioSelections: collectRadioSelections(radioGroupsConfig)
      });

      const embedSignatureFont = async (pdfDoc) => {
        try {
          const fontkit = await loadFontkitModule();
          pdfDoc.registerFontkit(fontkit);
          const signatureFontBytes = await loadSignatureFontBytes();
          return await pdfDoc.embedFont(signatureFontBytes);
        } catch (error) {
          console.error("Could not load custom signature font:", error);
          return null;
        }
      };

      const createFilledPdfBytes = async () => {
        const response = await fetch(blankPdfUrl);
        if (!response.ok) {
          throw new Error("Unable to load blank PDF form.");
        }

        const pdfBytes = await response.arrayBuffer();
        const pdfDoc = await PDFDocument.load(pdfBytes, { ignoreEncryption: true });

        const signatureFont = await embedSignatureFont(pdfDoc);
        const form = pdfDoc.getForm();
        const { textFields, signature, checkboxes, radioSelections } = collectFormValues();

        setTextFields(form, textFields);

        let signatureRect = null;
        let signaturePageIndex = 0;

        let signatureField = null;
        try {
          signatureField = form.getTextField("auth_whiner_signature");
        } catch (error) {
          console.warn("Could not access signature field:", error);
        }

        if (signatureField) {
          if (signature) {
            try {
              const widgets = signatureField.acroField.getWidgets();
              if (widgets.length > 0) {
                const widget = widgets[0];
                signatureRect = widget.getRectangle();
                signaturePageIndex = 0;
              }
            } catch (error) {
              console.warn("Could not get signature field rect:", error);
            }
          }

          try {
            signatureField.setText("");
          } catch (error) {
            console.warn("Could not reset signature field:", error);
          }
        }

        setCheckBoxes(form, checkboxes);
        applyRadioSelections(form, radioSelections);

        form.flatten();

        if (signature && signatureFont && signatureRect) {
          try {
            const pages = pdfDoc.getPages();
            const page = pages[signaturePageIndex] ?? pages[0];
            if (!page) {
              throw new Error("Unable to access the signature page.");
            }
            const fontSize = 16;
            const xPosition = signatureRect.x + 8;
            const yPosition = signatureRect.y + signatureRect.height / 2 - fontSize * 0.35;

            page.drawText(signature, {
              x: xPosition,
              y: yPosition,
              size: fontSize,
              font: signatureFont,
              color: { type: "RGB", red: 0, green: 0, blue: 0 }
            });
          } catch (error) {
            console.error("Could not draw signature with custom font:", error);
          }
        } else {
          console.log("Skipping signature draw:", {
            hasValue: !!signature,
            hasFont: !!signatureFont,
            hasRect: !!signatureRect
          });
        }

        const filledBytes = await pdfDoc.save();
        return filledBytes instanceof Uint8Array ? filledBytes : new Uint8Array(filledBytes);
      };

      const renderPdfToJpegs = (pdfBytes, { scale = 2, quality = 0.92 } = {}) => {
        const worker = new Worker(rendererWorkerUrl, { type: "module" });
        const pdfBytesCopy = pdfBytes.slice();
        return new Promise((resolve, reject) => {
          const pages = [];

          const cleanup = () => {
            worker.removeEventListener("message", handleMessage);
            worker.removeEventListener("error", handleError);
            worker.terminate();
          };

          const handleMessage = (event) => {
            const data = event.data;
            if (!data) {
              return;
            }

            if (data.type === "page") {
              const blob = new Blob([data.buffer], { type: "image/jpeg" });
              pages.push({ pageNum: data.pageNum, blob });
            } else if (data.type === "complete") {
              cleanup();
              pages.sort((a, b) => a.pageNum - b.pageNum);
              resolve(pages);
            } else if (data.type === "error") {
              cleanup();
              reject(new Error(data.message || "Unable to render PDF as JPG."));
            }
          };

          const handleError = (event) => {
            cleanup();
            reject(event.error || new Error("Unable to render PDF as JPG."));
          };

          worker.addEventListener("message", handleMessage);
          worker.addEventListener("error", handleError);

          worker.postMessage(
            {
              type: "render",
              pdfBytes: pdfBytesCopy.buffer,
              scale,
              quality
            },
            [pdfBytesCopy.buffer]
          );
        });
      };

      const runWithLoadingState = async (button, task, errorMessage) => {
        if (!validateForm()) {
          return;
        }

        const originalLabel = button?.textContent ?? "";

        if (button) {
          button.textContent = "Generating...";
        }
        setButtonsDisabled(true);

        try {
          await task();
        } catch (error) {
          console.error(error);
          alert(errorMessage);
        } finally {
          setButtonsDisabled(false);
          if (button) {
            button.textContent = originalLabel;
          }
        }
      };

      const handlePdfGeneration = async () => {
        const filledBytes = await createFilledPdfBytes();
        const blob = new Blob([filledBytes], { type: "application/pdf" });
        triggerDownload(blob, "butthurt.pdf");
      };

      const handleJpgGeneration = async () => {
        const filledBytes = await createFilledPdfBytes();
        const pages = await renderPdfToJpegs(filledBytes, { scale: 2, quality: 0.9 });
        if (!pages.length) {
          throw new Error("No pages were rendered from the PDF.");
        }

        const multiPage = pages.length > 1;
        for (const { pageNum, blob } of pages) {
          const paddedPage = String(pageNum).padStart(2, "0");
          const filename = multiPage ? `butthurt-page-${paddedPage}.jpg` : "butthurt.jpg";
          triggerDownload(blob, filename);
        }
      };

      pdfButton?.addEventListener("click", () =>
        runWithLoadingState(pdfButton, handlePdfGeneration, "We couldn't generate the PDF. Please try again.")
      );

      jpgButton?.addEventListener("click", () =>
        runWithLoadingState(jpgButton, handleJpgGeneration, "We couldn't generate the JPG. Please try again.")
      );
    </script>
  </body>
</html>
